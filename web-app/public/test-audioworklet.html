<!DOCTYPE html>
<html>
<head>
    <title>AudioWorklet Test</title>
</head>
<body>
    <h1>AudioWorklet Test</h1>
    <button id="testBtn">Test AudioWorklet</button>
    <div id="status"></div>
    <div id="log"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        
        function log(message) {
            console.log(message);
            logDiv.innerHTML += '<div>' + message + '</div>';
        }

        document.getElementById('testBtn').addEventListener('click', async () => {
            try {
                log('Starting AudioWorklet test...');
                
                // Create AudioContext
                const AC = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AC({ sampleRate: 48000 });
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                log('AudioContext created: ' + audioContext.sampleRate + 'Hz');
                
                // Load the worklet module
                await audioContext.audioWorklet.addModule('/pcm16-worklet.js');
                log('AudioWorklet module loaded successfully');
                
                // Create AudioWorkletNode
                const workletNode = new AudioWorkletNode(audioContext, 'pcm-worklet', {
                    processorOptions: { targetSampleRate: 16000, frameSize: 320 }
                });
                log('AudioWorkletNode created successfully');
                
                // Test message handling
                workletNode.port.onmessage = (event) => {
                    log('Received message from worklet: ' + JSON.stringify(event.data));
                };
                
                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: { ideal: 1 },
                        echoCancellation: { ideal: true },
                        noiseSuppression: { ideal: true },
                        autoGainControl: { ideal: true },
                    }
                });
                log('Microphone access granted');
                
                // Create source and connect
                const source = audioContext.createMediaStreamSource(stream);
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0; // Mute output
                
                source.connect(workletNode);
                workletNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                log('Audio graph connected successfully');
                statusDiv.innerHTML = '<div style="color: green;">✅ AudioWorklet test passed!</div>';
                
                // Clean up after 5 seconds
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    log('Test completed and cleaned up');
                }, 5000);
                
            } catch (error) {
                log('Error: ' + error.message);
                statusDiv.innerHTML = '<div style="color: red;">❌ AudioWorklet test failed: ' + error.message + '</div>';
                console.error(error);
            }
        });
    </script>
</body>
</html>

